<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Presensi Siswa SMK</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-active {
            background: white !important;
            color: #3b82f6 !important;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-H { background: #d1fae5; color: #065f46; }
        .status-PKL { background: #dbeafe; color: #1e40af; }
        .status-S { background: #fef3c7; color: #92400e; }
        .status-I { background: #e0e7ff; color: #3730a3; }
        .status-A { background: #fee2e2; color: #991b1b; }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            width: 120px;
            height: 120px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
            border-left: 4px solid #3b82f6;
        }
        
        /* Navbar Styles */
        .navbar {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-menu {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .nav-menu::-webkit-scrollbar {
            display: none;
        }
        
        .nav-item {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .mobile-menu {
            display: none;
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .mobile-menu {
                display: block;
            }
            
            .nav-menu.hidden {
                display: none;
            }
            
            .nav-menu.show {
                display: flex;
            }
        }
        
        /* Responsive Grid */
        @media (max-width: 640px) {
            .stat-card {
                padding: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .status-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* A4 Preview Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        /* A4 Paper Size */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        
        .print-table th {
            background: #f3f4f6;
            font-weight: bold;
        }
        
        .signature-box {
            border: 1px solid #333;
            padding: 1rem;
            min-height: 80px;
            margin-top: 0.5rem;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 via-sky-50 to-cyan-50 min-h-screen">
  <div class="w-full"><!-- Modern Navbar -->
   <nav class="navbar mb-8">
    <div class="container mx-auto px-4">
     <div class="flex items-center justify-between py-4"><!-- Logo & Title -->
      <div class="flex items-center gap-3"><img src="https://i.imgur.com/UVQedhI.png" alt="Logo Sekolah" class="w-12 h-12 md:w-16 md:h-16 object-contain" onerror="this.style.display='none';">
       <div>
        <h1 class="text-white text-xl md:text-2xl font-bold">Sistem Presensi Siswa</h1>
        <p class="text-blue-100 text-xs md:text-sm" id="school-header">SMK Negeri 4 Jakarta - 2024/2025</p>
       </div>
      </div><!-- Mobile Menu Button --> <button onclick="toggleMobileMenu()" class="mobile-menu text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
       </svg></button>
     </div><!-- Navigation Menu -->
     <div id="nav-menu" class="nav-menu pb-4 hidden md:flex"><button onclick="switchTab('input')" id="tab-input" class="nav-item tab-active px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300"> âœï¸ Input </button> <button onclick="switchTab('recap')" id="tab-recap" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> ğŸ“Š Rekap Kelas </button> <button onclick="switchTab('recap-student')" id="tab-recap-student" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> ğŸ‘¤ Rekap Siswa </button> <button onclick="switchTab('monthly')" id="tab-monthly" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> ğŸ“… Bulanan </button> <button onclick="switchTab('students')" id="tab-students" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> ğŸ‘¥ Kelola Siswa </button> <button onclick="switchTab('templates')" id="tab-templates" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> ğŸ“Š Template </button> <button onclick="switchTab('settings')" id="tab-settings" class="nav-item bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-300 hover:bg-opacity-30"> âš™ï¸ Pengaturan </button>
     </div>
    </div>
   </nav><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center"><img src="https://i.imgur.com/UVQedhI.png" alt="Loading..." class="loading-spinner" onerror="this.style.display='none';">
     <p class="mt-4 text-gray-700 font-semibold">Memuat data...</p>
    </div>
   </div><!-- Content Wrapper -->
   <div class="container mx-auto px-4 py-6 max-w-7xl"><!-- Tab Content: Input Presensi -->
    <div id="content-input" class="tab-content fade-in">
     <div class="card p-4 md:p-8 mb-6">
      <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ğŸ“ Input Presensi Harian</h2>
      <div class="grid md:grid-cols-2 gap-6 mb-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="input-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="">-- Pilih Kelas --</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal</label> <input type="date" id="input-date" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all">
       </div>
      </div><button onclick="loadStudentsForAttendance()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full md:w-auto"> ğŸ” Tampilkan Siswa </button>
     </div>
     <div id="attendance-form-container" class="hidden">
      <div class="card p-8">
       <h3 class="text-xl font-bold text-gray-800 mb-6">Daftar Siswa</h3>
       <div id="students-attendance-list" class="space-y-3"></div><button onclick="saveAttendance()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold mt-6"> ğŸ’¾ Simpan Presensi </button>
      </div>
     </div>
    </div><!-- Tab Content: Rekapitulasi -->
    <div id="content-recap" class="tab-content hidden">
     <div class="card p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“Š Rekapitulasi Per Siswa</h2>
      <div class="grid md:grid-cols-3 gap-6 mb-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="recap-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="">Semua Kelas</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Periode</label> <select id="recap-period" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="all">Semua Periode</option> <option value="sem1">Semester 1 (Jul-Des)</option> <option value="sem2">Semester 2 (Jan-Jun)</option> </select>
       </div>
       <div class="flex items-end"><button onclick="loadRecapitulation()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> ğŸ“ˆ Tampilkan </button>
       </div>
      </div>
     </div>
     <div id="recap-stats" class="grid md:grid-cols-5 gap-4 mb-6 hidden"></div>
     <div id="recap-table-container" class="card p-8 overflow-x-auto hidden">
      <table class="w-full" id="recap-table">
       <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
        <tr>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">NIS</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nama Siswa</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kelas</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Hadir</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">PKL</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Sakit</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Izin</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Alpha</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Total</th>
        </tr>
       </thead>
       <tbody id="recap-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
     </div>
    </div><!-- Tab Content: Rekapitulasi Per Siswa -->
    <div id="content-recap-student" class="tab-content hidden">
     <div class="card p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ‘¤ Rekapitulasi Presensi Per Siswa (Per Bulan)</h2>
      <div class="grid md:grid-cols-3 gap-6 mb-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="recap-student-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="">-- Pilih Kelas --</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Tahun</label> <select id="recap-student-year" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="2025">2025</option> <option value="2024">2024</option> </select>
       </div>
       <div class="flex items-end"><button onclick="loadStudentRecapList()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> ğŸ” Tampilkan Siswa </button>
       </div>
      </div>
     </div>
     <div id="student-cards-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
    </div><!-- A4 Preview Modal -->
    <div id="a4-preview-modal" class="modal-overlay hidden">
     <div class="modal-content">
      <div class="p-6 bg-gray-100 no-print">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">ğŸ“„ Preview Rekapitulasi A4</h3><button onclick="closeA4Preview()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all"> âœ– Tutup </button>
       </div>
       <div class="flex gap-3 mb-4"><button onclick="printA4()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all flex items-center gap-2"> ğŸ–¨ï¸ Cetak </button> <button onclick="downloadPDF()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"> ğŸ“¥ Download PDF </button>
       </div>
      </div>
      <div id="print-area" class="a4-paper"></div>
     </div>
    </div><!-- Delete By Class Modal -->
    <div id="delete-class-modal" class="modal-overlay hidden">
     <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
       <div class="text-6xl mb-4">
        âš ï¸
       </div>
       <h3 class="text-2xl font-bold text-gray-800 mb-2">Hapus Siswa Per Jurusan</h3>
       <p class="text-gray-600">Pilih kelas yang ingin dihapus. Tindakan ini tidak dapat dibatalkan!</p>
      </div>
      <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="delete-class-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"> <option value="">-- Pilih Kelas --</option> </select>
      </div>
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
       <p class="text-sm text-red-800"><strong>âš ï¸ Peringatan:</strong> Semua siswa di kelas terpilih akan dihapus permanen beserta semua data presensi mereka!</p>
      </div>
      <div class="flex gap-3"><button onclick="confirmDeleteByClass()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-all"> ğŸ—‘ï¸ Hapus Kelas </button> <button onclick="closeDeleteClassModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-semibold transition-all"> âŒ Batal </button>
      </div>
     </div>
    </div><!-- Delete All Modal -->
    <div id="delete-all-modal" class="modal-overlay hidden">
     <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
       <div class="text-6xl mb-4">
        ğŸš¨
       </div>
       <h3 class="text-2xl font-bold text-red-600 mb-2">HAPUS SEMUA SISWA?</h3>
       <p class="text-gray-600">Ini akan menghapus <strong>SEMUA DATA SISWA</strong> dan <strong>SEMUA PRESENSI</strong> secara permanen!</p>
      </div>
      <div class="bg-red-100 border-2 border-red-500 p-4 mb-6 rounded-lg">
       <p class="text-sm text-red-900 font-semibold text-center">âš ï¸ PERINGATAN KERAS âš ï¸</p>
       <p class="text-sm text-red-800 mt-2">Tindakan ini TIDAK DAPAT DIBATALKAN dan akan menghapus seluruh database siswa!</p>
      </div>
      <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Ketik <span class="text-red-600 font-bold">HAPUS SEMUA</span> untuk konfirmasi:</label> <input type="text" id="delete-all-confirmation" class="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:border-red-500 focus:outline-none" placeholder="Ketik: HAPUS SEMUA">
      </div>
      <div class="flex gap-3"><button onclick="confirmDeleteAll()" class="flex-1 bg-red-700 hover:bg-red-800 text-white px-6 py-3 rounded-lg font-semibold transition-all"> ğŸ—‘ï¸ Hapus Semua </button> <button onclick="closeDeleteAllModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-semibold transition-all"> âŒ Batal </button>
      </div>
     </div>
    </div><!-- Tab Content: Laporan Bulanan -->
    <div id="content-monthly" class="tab-content hidden">
     <div class="card p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“… Laporan Bulanan</h2>
      <div class="grid md:grid-cols-3 gap-6 mb-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Bulan</label> <select id="monthly-month" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="01">Januari</option> <option value="02">Februari</option> <option value="03">Maret</option> <option value="04">April</option> <option value="05">Mei</option> <option value="06">Juni</option> <option value="07">Juli</option> <option value="08">Agustus</option> <option value="09">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tahun</label> <select id="monthly-year" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-all"> <option value="2025">2025</option> <option value="2024">2024</option> </select>
       </div>
       <div class="flex items-end"><button onclick="loadMonthlyReport()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> ğŸ“Š Tampilkan </button>
       </div>
      </div>
     </div>
     <div id="monthly-summary" class="grid md:grid-cols-4 gap-4 mb-6 hidden"></div>
     <div id="monthly-table-container" class="card p-8 overflow-x-auto hidden">
      <div class="mb-4">
       <h3 class="text-xl font-bold text-gray-800" id="monthly-title"></h3>
      </div>
      <table class="w-full" id="monthly-table">
       <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
        <tr>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tanggal</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Hadir</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">PKL</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Sakit</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Izin</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Alpha</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Total</th>
        </tr>
       </thead>
       <tbody id="monthly-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
     </div>
    </div><!-- Tab Content: Template Data Siswa -->
    <div id="content-templates" class="tab-content hidden">
     <div class="card p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ Template Data Siswa</h2>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6 rounded-lg">
       <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ“ Cara Menggunakan Template:</h3>
       <ol class="list-decimal list-inside space-y-2 text-gray-700">
        <li>Download template Excel di bawah ini</li>
        <li>Isi data siswa sesuai format yang tersedia (NIS, Nama, L/P, Kelas)</li>
        <li>Simpan file Excel Anda</li>
        <li>Upload kembali file yang sudah diisi</li>
        <li>Sistem akan otomatis import data siswa ke database</li>
       </ol>
      </div>
      <div class="grid md:grid-cols-2 gap-6"><!-- Download Template -->
       <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
        <div class="flex items-center justify-between mb-4">
         <div>
          <h3 class="text-xl font-bold text-green-800">ğŸ“¥ Download Template</h3>
          <p class="text-sm text-gray-600 mt-1">Template kosong untuk diisi</p>
         </div>
         <div class="text-5xl">
          ğŸ“Š
         </div>
        </div><button onclick="downloadTemplate()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-lg hover:shadow-xl"> ğŸ“¥ Download Template Excel </button>
       </div><!-- Upload Template -->
       <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border-2 border-blue-200">
        <div class="flex items-center justify-between mb-4">
         <div>
          <h3 class="text-xl font-bold text-blue-800">ğŸ“¤ Upload Data Siswa</h3>
          <p class="text-sm text-gray-600 mt-1">Import dari file Excel</p>
         </div>
         <div class="text-5xl">
          â¬†ï¸
         </div>
        </div><input type="file" id="excel-file" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileUpload(event)"> <button onclick="document.getElementById('excel-file').click()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all shadow-lg hover:shadow-xl"> ğŸ“¤ Pilih File Excel </button>
       </div>
      </div><!-- Preview Import -->
      <div id="import-preview" class="hidden mt-6">
       <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg mb-4">
        <h3 class="text-lg font-bold text-yellow-800 mb-2">ğŸ‘€ Preview Data Import</h3>
        <p class="text-sm text-gray-700">Periksa data di bawah ini sebelum menyimpan ke database</p>
       </div>
       <div class="overflow-x-auto mb-4">
        <table class="w-full">
         <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
          <tr>
           <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">No</th>
           <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">NIS</th>
           <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Nama</th>
           <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">L/P</th>
           <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Kelas</th>
           <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Status</th>
          </tr>
         </thead>
         <tbody id="import-tbody"></tbody>
        </table>
       </div>
       <div class="flex gap-3"><button onclick="saveImportedData()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold"> ğŸ’¾ Simpan ke Database </button> <button onclick="cancelImport()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-all"> âŒ Batal </button>
       </div>
      </div>
     </div>
    </div><!-- Tab Content: Pengaturan Sekolah -->
    <div id="content-settings" class="tab-content hidden">
     <div class="card p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ Pengaturan Sekolah</h2>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6 rounded-lg">
       <p class="text-gray-700"><strong>ğŸ« Info:</strong> Pengaturan ini akan muncul pada semua laporan dan dokumen yang dicetak</p>
      </div>
      <div class="space-y-6">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Sekolah</label> <input type="text" id="setting-school-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: SMK Negeri 4 Jakarta">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tahun Ajaran</label> <input type="text" id="setting-academic-year" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: 2024/2025">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Alamat Sekolah</label> <input type="text" id="setting-address" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: Jl. Pendidikan No. 123, Jakarta Selatan">
       </div>
       <div class="grid md:grid-cols-2 gap-6">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nomor Telepon</label> <input type="text" id="setting-phone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: (021) 12345678">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Email Sekolah</label> <input type="email" id="setting-email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: info@smkn4jakarta.sch.id">
        </div>
       </div>
       <div class="flex gap-3 pt-4"><button onclick="saveSettings()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold"> ğŸ’¾ Simpan Pengaturan </button> <button onclick="resetSettings()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-all"> ğŸ”„ Reset ke Default </button>
       </div>
      </div>
     </div>
    </div><!-- Tab Content: Kelola Siswa -->
    <div id="content-students" class="tab-content hidden">
     <div class="card p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ‘¥ Kelola Data Siswa</h2>
      <div class="flex flex-wrap gap-3 mb-6"><button onclick="showAddStudentForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold"> â• Tambah Siswa Baru </button> <button onclick="showDeleteByClassModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition-all"> ğŸ—‘ï¸ Hapus Per Jurusan </button> <button onclick="showDeleteAllModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-all"> âš ï¸ Hapus Semua Siswa </button>
      </div>
      <div id="add-student-form" class="hidden bg-blue-50 p-6 rounded-lg mb-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">Form Tambah Siswa</h3>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">NIS</label> <input type="text" id="new-nis" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: 2024001">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="new-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Nama Siswa">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Jenis Kelamin</label> <select id="new-gender" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"> <option value="L">Laki-laki</option> <option value="P">Perempuan</option> </select>
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label> <input type="text" id="new-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Contoh: X - TKJ-1">
        </div>
       </div>
       <div class="flex gap-3 mt-4"><button onclick="saveNewStudent()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold"> ğŸ’¾ Simpan </button> <button onclick="cancelAddStudent()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-all"> âŒ Batal </button>
       </div>
      </div>
      <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Filter Kelas</label> <select id="students-class-filter" onchange="loadStudentsList()" class="w-full md:w-64 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"> <option value="">Semua Kelas</option> </select>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
         <tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">NIS</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nama</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">L/P</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kelas</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Aksi</th>
         </tr>
        </thead>
        <tbody id="students-tbody" class="divide-y divide-gray-200"></tbody>
       </table>
      </div>
     </div>
    </div>
   </div><!-- End Content Wrapper -->
  </div><!-- End Main Wrapper -->
  <script>
        // ========================================================================
        // SUPABASE CONFIGURATION - CREDENTIALS YANG BENAR
        // ========================================================================
        const SUPABASE_URL = 'https://xkvwtnbvierjgfbhhbeg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrdnd0bmJ2aWVyamdmYmhoYmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMzA5MzMsImV4cCI6MjA4MDkwNjkzM30.6NLqvOnX3IqY1FVjJH0sfeW08W-Bp4D6k9ztqKvtw50';
        
        console.log('ğŸ”§ Initializing Supabase...');
        console.log('ğŸ“ URL:', SUPABASE_URL);
        console.log('ğŸ”‘ Key:', SUPABASE_KEY.substring(0, 20) + '...');
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ========================================================================
        // GLOBAL VARIABLES
        // ========================================================================
        let currentStudents = [];
        let allClasses = [];
        let importedStudents = [];
        
        // School Settings dengan default values
        let schoolSettings = {
            schoolName: 'SMK Negeri 4 Jakarta',
            academicYear: '2024/2025',
            address: 'Jl. Pendidikan No. 123, Jakarta Selatan',
            phone: '(021) 12345678',
            email: 'info@smkn4jakarta.sch.id'
        };

        // ========================================================================
        // UTILITY FUNCTIONS
        // ========================================================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        function formatDateShort(dateString) {
            const options = { day: '2-digit', month: 'short' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // ========================================================================
        // TAB SWITCHING
        // ========================================================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.remove('bg-white');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('tab-active');
            activeBtn.classList.remove('bg-white', 'bg-opacity-20', 'text-white');
            
            // Save current tab to localStorage
            localStorage.setItem('currentTab', tabName);
            
            // Close mobile menu after selection
            const navMenu = document.getElementById('nav-menu');
            if (window.innerWidth < 768) {
                navMenu.classList.remove('show');
                navMenu.classList.add('hidden');
            }
            
            // Load data based on tab
            if (tabName === 'input') {
                loadClassOptions();
                setTodayDate();
            } else if (tabName === 'recap') {
                loadClassOptions();
            } else if (tabName === 'recap-student') {
                loadClassOptions();
            } else if (tabName === 'monthly') {
                setCurrentMonth();
            } else if (tabName === 'students') {
                loadClassOptions();
                loadStudentsList();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }
        
        function toggleMobileMenu() {
            const navMenu = document.getElementById('nav-menu');
            if (navMenu.classList.contains('hidden')) {
                navMenu.classList.remove('hidden');
                navMenu.classList.add('show');
            } else {
                navMenu.classList.add('hidden');
                navMenu.classList.remove('show');
            }
        }

        // ========================================================================
        // LOAD CLASS OPTIONS
        // ========================================================================
        async function loadClassOptions() {
            try {
                console.log('ğŸ” Loading classes from Supabase...');
                
                const { data, error } = await supabase
                    .from('students')
                    .select('classname')
                    .eq('is_active', true);
                
                if (error) {
                    console.error('âŒ Supabase error:', error);
                    throw error;
                }
                
                console.log('âœ… Data received:', data);
                
                if (!data || data.length === 0) {
                    showNotification('âš ï¸ Tidak ada data siswa. Jalankan SQL script!', 'error');
                    return;
                }
                
                // Get unique classes
                allClasses = [...new Set(data.map(s => s.classname))].sort();
                console.log('ğŸ“š Classes found:', allClasses);
                
                // Populate all class dropdowns
                const classSelects = [
                    'input-class', 
                    'recap-class',
                    'recap-student-class',
                    'students-class-filter'
                ];
                
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Keep first option (placeholder)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    
                    // Add class options
                    allClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        select.appendChild(option);
                    });
                    
                    // Restore previous value if exists
                    if (currentValue) select.value = currentValue;
                });
                
                showNotification('âœ… Daftar kelas berhasil dimuat!', 'success');
            } catch (error) {
                console.error('âŒ Error loading classes:', error);
                showNotification(`Gagal memuat: ${error.message}`, 'error');
            }
        }

        // ========================================================================
        // INPUT PRESENSI FUNCTIONS
        // ========================================================================
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
        }

        async function loadStudentsForAttendance() {
            const className = document.getElementById('input-class').value;
            const date = document.getElementById('input-date').value;
            
            if (!className) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            if (!date) {
                showNotification('Pilih tanggal terlebih dahulu!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Get students
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .eq('classname', className)
                    .eq('is_active', true)
                    .order('name');
                
                if (studentsError) throw studentsError;
                
                // Get existing attendance for this date (dengan limit 5000)
                const { data: existingAttendance, error: attendanceError } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('attendance_date', date)
                    .limit(5000);
                
                if (attendanceError) throw attendanceError;
                
                // Create attendance map
                const attendanceMap = {};
                existingAttendance.forEach(a => {
                    attendanceMap[a.student_id] = a.status;
                });
                
                // Store students globally
                currentStudents = students.map(s => ({
                    ...s,
                    currentStatus: attendanceMap[s.id] || 'H'
                }));
                
                // Render students list
                renderStudentsAttendance();
                
                document.getElementById('attendance-form-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Gagal memuat data siswa', 'error');
                hideLoading();
            }
        }

        function renderStudentsAttendance() {
            const container = document.getElementById('students-attendance-list');
            container.innerHTML = '';
            
            currentStudents.forEach((student, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all';
                
                row.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${student.name}</p>
                        <p class="text-sm text-gray-600">NIS: ${student.nis}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setAttendanceStatus(${index}, 'H')" 
                                class="status-btn ${student.currentStatus === 'H' ? 'bg-green-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            H
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'PKL')" 
                                class="status-btn ${student.currentStatus === 'PKL' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            PKL
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'S')" 
                                class="status-btn ${student.currentStatus === 'S' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            S
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'I')" 
                                class="status-btn ${student.currentStatus === 'I' ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            I
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'A')" 
                                class="status-btn ${student.currentStatus === 'A' ? 'bg-red-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            A
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        function setAttendanceStatus(index, status) {
            currentStudents[index].currentStatus = status;
            renderStudentsAttendance();
        }

        async function saveAttendance() {
            const date = document.getElementById('input-date').value;
            
            if (!currentStudents.length) {
                showNotification('Tidak ada data siswa', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Delete existing attendance for this date and students
                const studentIds = currentStudents.map(s => s.id);
                await supabase
                    .from('attendance')
                    .delete()
                    .eq('attendance_date', date)
                    .in('student_id', studentIds);
                
                // Insert new attendance
                const attendanceData = currentStudents.map(s => ({
                    student_id: s.id,
                    attendance_date: date,
                    status: s.currentStatus
                }));
                
                const { error } = await supabase
                    .from('attendance')
                    .insert(attendanceData);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Presensi berhasil disimpan!', 'success');
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('Gagal menyimpan presensi', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // REKAPITULASI FUNCTIONS
        // ========================================================================
        async function loadRecapitulation() {
            const className = document.getElementById('recap-class').value;
            const period = document.getElementById('recap-period').value;
            
            showLoading();
            
            try {
                // Build query for students
                let studentsQuery = supabase
                    .from('students')
                    .select('*')
                    .eq('is_active', true)
                    .order('classname')
                    .order('name');
                
                if (className) {
                    studentsQuery = studentsQuery.eq('classname', className);
                }
                
                const { data: students, error: studentsError } = await studentsQuery;
                if (studentsError) throw studentsError;
                
                // Build query for attendance based on period (dengan limit 5000)
                let attendanceQuery = supabase
                    .from('attendance')
                    .select('*');
                
                if (period === 'sem1') {
                    attendanceQuery = attendanceQuery
                        .gte('attendance_date', '2024-07-01')
                        .lte('attendance_date', '2024-12-31');
                } else if (period === 'sem2') {
                    attendanceQuery = attendanceQuery
                        .gte('attendance_date', '2025-01-01')
                        .lte('attendance_date', '2025-06-30');
                }
                
                const { data: attendance, error: attendanceError } = await attendanceQuery.limit(5000);
                if (attendanceError) throw attendanceError;
                
                // Calculate statistics
                const stats = {
                    totalH: 0,
                    totalPKL: 0,
                    totalS: 0,
                    totalI: 0,
                    totalA: 0
                };
                
                const studentStats = students.map(student => {
                    const studentAttendance = attendance.filter(a => a.student_id === student.id);
                    
                    const H = studentAttendance.filter(a => a.status === 'H').length;
                    const PKL = studentAttendance.filter(a => a.status === 'PKL').length;
                    const S = studentAttendance.filter(a => a.status === 'S').length;
                    const I = studentAttendance.filter(a => a.status === 'I').length;
                    const A = studentAttendance.filter(a => a.status === 'A').length;
                    
                    stats.totalH += H;
                    stats.totalPKL += PKL;
                    stats.totalS += S;
                    stats.totalI += I;
                    stats.totalA += A;
                    
                    return {
                        ...student,
                        H, PKL, S, I, A,
                        total: H + PKL + S + I + A
                    };
                });
                
                // Render stats cards
                renderRecapStats(stats);
                
                // Render table
                renderRecapTable(studentStats);
                
                document.getElementById('recap-stats').classList.remove('hidden');
                document.getElementById('recap-table-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading recapitulation:', error);
                showNotification('Gagal memuat rekapitulasi', 'error');
                hideLoading();
            }
        }

        function renderRecapStats(stats) {
            const container = document.getElementById('recap-stats');
            container.innerHTML = `
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-green-600">${stats.totalH}</div>
                    <div class="text-sm text-gray-600 mt-1">Hadir</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-blue-600">${stats.totalPKL}</div>
                    <div class="text-sm text-gray-600 mt-1">PKL</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-yellow-600">${stats.totalS}</div>
                    <div class="text-sm text-gray-600 mt-1">Sakit</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-indigo-600">${stats.totalI}</div>
                    <div class="text-sm text-gray-600 mt-1">Izin</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-red-600">${stats.totalA}</div>
                    <div class="text-sm text-gray-600 mt-1">Alpha</div>
                </div>
            `;
        }

        function renderRecapTable(studentStats) {
            const tbody = document.getElementById('recap-tbody');
            tbody.innerHTML = '';
            
            studentStats.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-all';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${student.nis}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${student.name}</td>
                    <td class="px-4 py-3 text-sm">${student.classname}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-green-600">${student.H}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-blue-600">${student.PKL}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-yellow-600">${student.S}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-indigo-600">${student.I}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-red-600">${student.A}</td>
                    <td class="px-4 py-3 text-center text-sm font-bold">${student.total}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========================================================================
        // REKAPITULASI PER SISWA FUNCTIONS
        // ========================================================================
        let currentRecapData = null;

        async function loadStudentRecapList() {
            const className = document.getElementById('recap-student-class').value;
            const year = document.getElementById('recap-student-year').value;
            
            if (!className) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Get students
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .eq('classname', className)
                    .eq('is_active', true)
                    .order('name');
                
                if (studentsError) throw studentsError;
                
                // Get attendance for the whole year (dengan limit 5000)
                const { data: attendance, error: attendanceError } = await supabase
                    .from('attendance')
                    .select('*')
                    .gte('attendance_date', `${year}-01-01`)
                    .lte('attendance_date', `${year}-12-31`)
                    .order('attendance_date')
                    .limit(5000);
                
                if (attendanceError) throw attendanceError;
                
                // Process data for each student per month
                const studentRecaps = students.map(student => {
                    const studentAttendance = attendance.filter(a => a.student_id === student.id);
                    
                    // Group by month
                    const monthlyData = {};
                    for (let month = 1; month <= 12; month++) {
                        const monthStr = String(month).padStart(2, '0');
                        const monthAttendance = studentAttendance.filter(a => 
                            a.attendance_date.startsWith(`${year}-${monthStr}`)
                        );
                        
                        monthlyData[monthStr] = {
                            H: monthAttendance.filter(a => a.status === 'H').length,
                            PKL: monthAttendance.filter(a => a.status === 'PKL').length,
                            S: monthAttendance.filter(a => a.status === 'S').length,
                            I: monthAttendance.filter(a => a.status === 'I').length,
                            A: monthAttendance.filter(a => a.status === 'A').length,
                            attendance: monthAttendance
                        };
                    }
                    
                    return {
                        student,
                        year,
                        monthlyData
                    };
                });
                
                renderStudentCards(studentRecaps);
                
                document.getElementById('student-cards-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading student recapitulation:', error);
                showNotification('Gagal memuat data rekapitulasi', 'error');
                hideLoading();
            }
        }

        function renderStudentCards(studentRecaps) {
            const container = document.getElementById('student-cards-container');
            container.innerHTML = '';
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            studentRecaps.forEach((recap, studentIndex) => {
                const { student, year, monthlyData } = recap;
                
                const card = document.createElement('div');
                card.className = 'card p-6 hover:shadow-xl transition-all';
                
                let monthButtons = '';
                for (let month = 1; month <= 12; month++) {
                    const monthStr = String(month).padStart(2, '0');
                    const data = monthlyData[monthStr];
                    const total = data.H + data.PKL + data.S + data.I + data.A;
                    
                    monthButtons += `
                        <button onclick="showMonthlyA4Preview(${studentIndex}, '${monthStr}')" 
                                class="bg-gradient-to-r from-blue-100 to-cyan-100 hover:from-blue-200 hover:to-cyan-200 p-3 rounded-lg text-left transition-all hover:shadow-md">
                            <div class="text-xs font-semibold text-blue-700 mb-1">ğŸ“… ${monthNames[month - 1].toUpperCase()} ${year}</div>
                            <div class="flex gap-1 text-xs">
                                <span class="text-green-600 font-bold">H:${data.H}</span>
                                <span class="text-blue-600 font-bold">PKL:${data.PKL}</span>
                                <span class="text-yellow-600 font-bold">S:${data.S}</span>
                                <span class="text-indigo-600 font-bold">I:${data.I}</span>
                                <span class="text-red-600 font-bold">A:${data.A}</span>
                            </div>
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
                            <p class="text-sm text-gray-600">NIS: ${student.nis}</p>
                            <p class="text-sm text-gray-600">${student.classname} â€¢ ${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</p>
                        </div>
                        <div class="text-3xl">
                            ${student.gender === 'L' ? 'ğŸ‘¨â€ğŸ“' : 'ğŸ‘©â€ğŸ“'}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Pilih Bulan untuk Cetak PDF:</h4>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        ${monthButtons}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Store data globally for preview
            window.studentRecapsData = studentRecaps;
        }

        function showMonthlyA4Preview(studentIndex, month) {
            const recap = window.studentRecapsData[studentIndex];
            if (!recap) return;
            
            const { student, year, monthlyData } = recap;
            const monthData = monthlyData[month];
            const { H, PKL, S, I, A, attendance } = monthData;
            const total = H + PKL + S + I + A;
            
            currentRecapData = { student, year, month, monthData };
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const monthName = monthNames[parseInt(month) - 1];
            
            // Generate A4 content
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="font-family: Arial, sans-serif; color: #333;">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 3px solid #333; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                        <h1 style="margin: 0; font-size: 24px; font-weight: bold;">${schoolSettings.schoolName.toUpperCase()}</h1>
                        <p style="margin: 0.25rem 0; font-size: 14px;">${schoolSettings.address}</p>
                        <p style="margin: 0.25rem 0; font-size: 14px;">Telp: ${schoolSettings.phone} | Email: ${schoolSettings.email}</p>
                    </div>
                    
                    <!-- Title -->
                    <h2 style="text-align: center; margin: 1.5rem 0; font-size: 18px; font-weight: bold; text-transform: uppercase;">
                        Rekapitulasi Presensi Siswa
                    </h2>
                    
                    <!-- Student Info -->
                    <table style="width: 100%; margin-bottom: 1.5rem; font-size: 14px;">
                        <tr>
                            <td style="width: 120px; padding: 0.25rem 0;"><strong>NIS</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.nis}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Nama Lengkap</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.name}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Jenis Kelamin</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Kelas</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.classname}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Periode</strong></td>
                            <td style="padding: 0.25rem 0;">: <strong>${monthName} ${year}</strong></td>
                        </tr>
                    </table>
                    
                    <!-- Summary Stats -->
                    <h3 style="font-size: 16px; font-weight: bold; margin: 1.5rem 0 1rem 0;">Ringkasan Kehadiran - ${monthName} ${year}</h3>
                    <table class="print-table" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="background: #dcfce7; color: #166534;">Hadir (H)</th>
                                <th style="background: #dbeafe; color: #1e40af;">PKL</th>
                                <th style="background: #fef3c7; color: #92400e;">Sakit (S)</th>
                                <th style="background: #e0e7ff; color: #3730a3;">Izin (I)</th>
                                <th style="background: #fee2e2; color: #991b1b;">Alpha (A)</th>
                                <th style="background: #f3e8ff; color: #6b21a8;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="text-align: center; font-weight: bold;">
                                <td style="color: #16a34a; font-size: 18px;">${H}</td>
                                <td style="color: #2563eb; font-size: 18px;">${PKL}</td>
                                <td style="color: #ca8a04; font-size: 18px;">${S}</td>
                                <td style="color: #4f46e5; font-size: 18px;">${I}</td>
                                <td style="color: #dc2626; font-size: 18px;">${A}</td>
                                <td style="color: #9333ea; font-size: 18px;">${total}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Detail Attendance -->
                    <h3 style="font-size: 16px; font-weight: bold; margin: 1.5rem 0 1rem 0;">Detail Presensi ${monthName} ${year}</h3>
                    ${(() => {
                        // Hitung jumlah hari dalam bulan
                        const daysInMonth = new Date(year, parseInt(month), 0).getDate();
                        
                        // Loop semua tanggal dari 1 sampai akhir bulan
                        let tableRows = '';
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dayStr = String(day).padStart(2, '0');
                            const dateStr = `${year}-${month}-${dayStr}`;
                            
                            // Cari data presensi untuk tanggal ini
                            const att = attendance.find(a => a.attendance_date === dateStr);
                            
                            if (att) {
                                // Ada data presensi
                                tableRows += `
                                    <tr>
                                        <td style="text-align: center;">${day}</td>
                                        <td>${formatDate(dateStr)}</td>
                                        <td style="text-align: center;">
                                            <span style="
                                                display: inline-block;
                                                padding: 4px 12px;
                                                border-radius: 12px;
                                                font-weight: bold;
                                                font-size: 11px;
                                                ${att.status === 'H' ? 'background: #dcfce7; color: #166534;' : ''}
                                                ${att.status === 'PKL' ? 'background: #dbeafe; color: #1e40af;' : ''}
                                                ${att.status === 'S' ? 'background: #fef3c7; color: #92400e;' : ''}
                                                ${att.status === 'I' ? 'background: #e0e7ff; color: #3730a3;' : ''}
                                                ${att.status === 'A' ? 'background: #fee2e2; color: #991b1b;' : ''}
                                            ">
                                                ${att.status === 'H' ? 'HADIR' : att.status === 'PKL' ? 'PKL' : att.status === 'S' ? 'SAKIT' : att.status === 'I' ? 'IZIN' : 'ALPHA'}
                                            </span>
                                        </td>
                                        <td>${att.notes || '-'}</td>
                                    </tr>
                                `;
                            } else {
                                // Tidak ada data presensi - tampilkan baris kosong
                                tableRows += `
                                    <tr style="background: #fafafa;">
                                        <td style="text-align: center; color: #999;">${day}</td>
                                        <td style="color: #999;">${formatDate(dateStr)}</td>
                                        <td style="text-align: center; color: #999;">-</td>
                                        <td style="color: #999; font-style: italic;">Tidak ada data</td>
                                    </tr>
                                `;
                            }
                        }
                        
                        return `
                            <table class="print-table" style="font-size: 12px;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px; text-align: center;">No</th>
                                        <th>Tanggal</th>
                                        <th style="width: 100px; text-align: center;">Status</th>
                                        <th>Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        `;
                    })()}
                    
                    <!-- Keterangan -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-left: 4px solid #3b82f6; font-size: 12px;">
                        <strong>Keterangan:</strong><br>
                        <strong>H</strong> = Hadir | 
                        <strong>PKL</strong> = Praktik Kerja Lapangan | 
                        <strong>S</strong> = Sakit | 
                        <strong>I</strong> = Izin | 
                        <strong>A</strong> = Alpha (Tanpa Keterangan)
                    </div>
                    
                    <!-- Signatures -->
                    <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; font-size: 13px;">
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong>Wali Kelas,</strong></p>
                            <div class="signature-box"></div>
                            <p style="margin: 0.5rem 0 0 0; text-align: center;">(...........................)</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong>Orang Tua/Wali,</strong></p>
                            <div class="signature-box"></div>
                            <p style="margin: 0.5rem 0 0 0; text-align: center;">(...........................)</p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; text-align: center; font-size: 11px; color: #666;">
                        <p style="margin: 0;">Dicetak ${new Date().toLocaleDateString('id-ID', { 
                            day: 'numeric', 
                            month: 'long', 
                            year: 'numeric' 
                        })}</p>
                        <p style="margin: 0.25rem 0 0 0;">Sistem dibuat Oleh Muhammad Syaeful Amin</p>
                    </div>
                </div>
            `;
            
            // Show modal
            document.getElementById('a4-preview-modal').classList.remove('hidden');
        }

        function closeA4Preview() {
            document.getElementById('a4-preview-modal').classList.add('hidden');
            currentRecapData = null;
        }

        function printA4() {
            window.print();
        }

        async function downloadPDF() {
            if (!currentRecapData) return;
            
            showLoading();
            
            try {
                const element = document.getElementById('print-area');
                const { student, year, month } = currentRecapData;
                
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                const monthName = monthNames[parseInt(month) - 1];
                
                // Generate filename
                const studentName = student.name.replace(/\s+/g, '_');
                const filename = `Rekapitulasi_${studentName}_${monthName}_${year}.pdf`;
                
                // PDF options
                const opt = {
                    margin: 10,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generate PDF
                await html2pdf().set(opt).from(element).save();
                
                hideLoading();
                showNotification('PDF berhasil diunduh!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Gagal mengunduh PDF', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // MONTHLY REPORT FUNCTIONS
        // ========================================================================
        function setCurrentMonth() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('monthly-month').value = month;
            document.getElementById('monthly-year').value = year;
        }

        async function loadMonthlyReport() {
            const month = document.getElementById('monthly-month').value;
            const year = document.getElementById('monthly-year').value;
            
            showLoading();
            
            try {
                const startDate = `${year}-${month}-01`;
                // Hitung tanggal terakhir bulan terpilih (28, 29, 30, atau 31) secara otomatis
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;
                
                // Ambil data dengan limit 5000
                const { data: attendance, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .gte('attendance_date', startDate)
                    .lte('attendance_date', endDate)
                    .order('attendance_date')
                    .limit(5000);
                
                if (error) throw error;
                
                // Group by date
                const dateMap = {};
                attendance.forEach(a => {
                    if (!dateMap[a.attendance_date]) {
                        dateMap[a.attendance_date] = { H: 0, PKL: 0, S: 0, I: 0, A: 0 };
                    }
                    dateMap[a.attendance_date][a.status]++;
                });
                
                // Calculate summary
                const summary = { H: 0, PKL: 0, S: 0, I: 0, A: 0 };
                Object.values(dateMap).forEach(day => {
                    summary.H += day.H;
                    summary.PKL += day.PKL;
                    summary.S += day.S;
                    summary.I += day.I;
                    summary.A += day.A;
                });
                
                // Render
                renderMonthlySummary(summary);
                renderMonthlyTable(dateMap);
                
                // Update title
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                document.getElementById('monthly-title').textContent = 
                    `Laporan Bulan ${monthNames[parseInt(month) - 1]} ${year}`;
                
                document.getElementById('monthly-summary').classList.remove('hidden');
                document.getElementById('monthly-table-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading monthly report:', error);
                showNotification('Gagal memuat laporan bulanan', 'error');
                hideLoading();
            }
        }

        function renderMonthlySummary(summary) {
            const container = document.getElementById('monthly-summary');
            container.innerHTML = `
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-green-600">${summary.H}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Hadir</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-blue-600">${summary.PKL}</div>
                    <div class="text-sm text-gray-600 mt-1">Total PKL</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-yellow-600">${summary.S}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Sakit</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-red-600">${summary.I + summary.A}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Izin + Alpha</div>
                </div>
            `;
        }

        function renderMonthlyTable(dateMap) {
            const tbody = document.getElementById('monthly-tbody');
            tbody.innerHTML = '';
            
            Object.keys(dateMap).sort().forEach(date => {
                const day = dateMap[date];
                const total = day.H + day.PKL + day.S + day.I + day.A;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-all';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-semibold">${formatDate(date)}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-green-600">${day.H}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-blue-600">${day.PKL}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-yellow-600">${day.S}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-indigo-600">${day.I}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-red-600">${day.A}</td>
                    <td class="px-4 py-3 text-center text-sm font-bold">${total}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========================================================================
        // STUDENTS MANAGEMENT FUNCTIONS
        // ========================================================================
        function showAddStudentForm() {
            document.getElementById('add-student-form').classList.remove('hidden');
        }

        function cancelAddStudent() {
            document.getElementById('add-student-form').classList.add('hidden');
            document.getElementById('new-nis').value = '';
            document.getElementById('new-name').value = '';
            document.getElementById('new-class').value = '';
        }

        async function saveNewStudent() {
            const nis = document.getElementById('new-nis').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const gender = document.getElementById('new-gender').value;
            const classname = document.getElementById('new-class').value.trim();
            
            if (!nis || !name || !classname) {
                showNotification('Lengkapi semua field!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('students')
                    .insert([{
                        nis,
                        name: name.toUpperCase(),
                        gender,
                        classname
                    }]);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Siswa berhasil ditambahkan!', 'success');
                cancelAddStudent();
                loadStudentsList();
                loadClassOptions();
            } catch (error) {
                console.error('Error adding student:', error);
                if (error.code === '23505') {
                    showNotification('NIS sudah terdaftar!', 'error');
                } else {
                    showNotification('Gagal menambahkan siswa', 'error');
                }
                hideLoading();
            }
        }

        async function loadStudentsList() {
            const classFilter = document.getElementById('students-class-filter').value;
            
            showLoading();
            
            try {
                let query = supabase
                    .from('students')
                    .select('*')
                    .order('classname')
                    .order('name');
                
                if (classFilter) {
                    query = query.eq('classname', classFilter);
                }
                
                const { data: students, error } = await query;
                if (error) throw error;
                
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-blue-50 transition-all';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${student.nis}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${student.name}</td>
                        <td class="px-4 py-3 text-sm">${student.gender}</td>
                        <td class="px-4 py-3 text-sm">${student.classname}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="status-badge ${student.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${student.is_active ? 'Aktif' : 'Nonaktif'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="toggleStudentStatus('${student.id}', ${!student.is_active})" 
                                    class="text-sm px-3 py-1 rounded ${student.is_active ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} transition-all">
                                ${student.is_active ? 'ğŸš« Nonaktifkan' : 'âœ… Aktifkan'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoading();
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Gagal memuat daftar siswa', 'error');
                hideLoading();
            }
        }

        async function toggleStudentStatus(studentId, newStatus) {
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({ is_active: newStatus })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Status siswa berhasil diubah!', 'success');
                loadStudentsList();
            } catch (error) {
                console.error('Error updating student status:', error);
                showNotification('Gagal mengubah status siswa', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // DELETE FUNCTIONS
        // ========================================================================
        function showDeleteByClassModal() {
            // Populate class dropdown
            const select = document.getElementById('delete-class-select');
            select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            
            allClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                select.appendChild(option);
            });
            
            document.getElementById('delete-class-modal').classList.remove('hidden');
        }

        function closeDeleteClassModal() {
            document.getElementById('delete-class-modal').classList.add('hidden');
            document.getElementById('delete-class-select').value = '';
        }

        async function confirmDeleteByClass() {
            const className = document.getElementById('delete-class-select').value;
            
            if (!className) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Get students in this class
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('id')
                    .eq('classname', className);
                
                if (studentsError) throw studentsError;
                
                if (!students || students.length === 0) {
                    showNotification('Tidak ada siswa di kelas ini!', 'error');
                    hideLoading();
                    return;
                }
                
                const studentIds = students.map(s => s.id);
                
                // Delete attendance records first
                const { error: attendanceError } = await supabase
                    .from('attendance')
                    .delete()
                    .in('student_id', studentIds);
                
                if (attendanceError) throw attendanceError;
                
                // Delete students
                const { error: deleteError } = await supabase
                    .from('students')
                    .delete()
                    .eq('classname', className);
                
                if (deleteError) throw deleteError;
                
                hideLoading();
                showNotification(`Berhasil menghapus ${students.length} siswa dari kelas ${className}!`, 'success');
                closeDeleteClassModal();
                loadClassOptions();
                loadStudentsList();
            } catch (error) {
                console.error('Error deleting students by class:', error);
                showNotification('Gagal menghapus siswa!', 'error');
                hideLoading();
            }
        }

        function showDeleteAllModal() {
            document.getElementById('delete-all-modal').classList.remove('hidden');
            document.getElementById('delete-all-confirmation').value = '';
        }

        function closeDeleteAllModal() {
            document.getElementById('delete-all-modal').classList.add('hidden');
            document.getElementById('delete-all-confirmation').value = '';
        }

        async function confirmDeleteAll() {
            const confirmation = document.getElementById('delete-all-confirmation').value.trim();
            
            if (confirmation !== 'HAPUS SEMUA') {
                showNotification('Ketik "HAPUS SEMUA" untuk konfirmasi!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Delete all attendance first
                const { error: attendanceError } = await supabase
                    .from('attendance')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all records
                
                if (attendanceError) throw attendanceError;
                
                // Delete all students
                const { error: studentsError } = await supabase
                    .from('students')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all records
                
                if (studentsError) throw studentsError;
                
                hideLoading();
                showNotification('Semua data siswa dan presensi berhasil dihapus!', 'success');
                closeDeleteAllModal();
                
                // Reload data
                allClasses = [];
                loadClassOptions();
                loadStudentsList();
            } catch (error) {
                console.error('Error deleting all data:', error);
                showNotification('Gagal menghapus data!', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // TEMPLATE FUNCTIONS
        // ========================================================================
        function downloadTemplate() {
            // Create sample data
            const templateData = [
                ['NIS', 'Nama Lengkap', 'L/P', 'Kelas'],
                ['2024001', 'AHMAD ZAKI', 'L', 'X - TKJ-1'],
                ['2024002', 'SITI NURHALIZA', 'P', 'X - TKJ-1'],
                ['2024003', 'BUDI SANTOSO', 'L', 'X - RPL-1'],
                ['', '', '', ''],
                ['', '', '', '']
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 15 },
                { wch: 30 },
                { wch: 8 },
                { wch: 20 }
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Data Siswa');
            
            // Download file
            XLSX.writeFile(wb, 'Template_Data_Siswa.xlsx');
            showNotification('Template berhasil didownload!', 'success');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading();
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Skip header row and process data
                importedStudents = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row[0] && row[1]) { // Check if NIS and Name exist
                        importedStudents.push({
                            nis: String(row[0]).trim(),
                            name: String(row[1]).trim().toUpperCase(),
                            gender: String(row[2]).trim().toUpperCase() === 'P' ? 'P' : 'L',
                            classname: String(row[3]).trim()
                        });
                    }
                }
                
                if (importedStudents.length === 0) {
                    showNotification('Tidak ada data valid di file Excel!', 'error');
                    hideLoading();
                    return;
                }
                
                // Preview imported data
                renderImportPreview();
                document.getElementById('import-preview').classList.remove('hidden');
                
                hideLoading();
                showNotification(`${importedStudents.length} data siswa berhasil dibaca!`, 'success');
            } catch (error) {
                console.error('Error reading file:', error);
                showNotification('Gagal membaca file Excel!', 'error');
                hideLoading();
            }
            
            // Reset input
            event.target.value = '';
        }

        function renderImportPreview() {
            const tbody = document.getElementById('import-tbody');
            tbody.innerHTML = '';
            
            importedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-all';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-center">${index + 1}</td>
                    <td class="px-4 py-3 text-sm">${student.nis}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${student.name}</td>
                    <td class="px-4 py-3 text-sm">${student.gender}</td>
                    <td class="px-4 py-3 text-sm">${student.classname}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="status-badge bg-blue-100 text-blue-800">Siap Import</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function saveImportedData() {
            if (importedStudents.length === 0) {
                showNotification('Tidak ada data untuk disimpan!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('students')
                    .insert(importedStudents);
                
                if (error) throw error;
                
                hideLoading();
                showNotification(`${importedStudents.length} siswa berhasil ditambahkan!`, 'success');
                cancelImport();
                loadClassOptions();
                
                // Switch to students tab
                switchTab('students');
            } catch (error) {
                console.error('Error saving imported data:', error);
                if (error.code === '23505') {
                    showNotification('Ada NIS yang sudah terdaftar!', 'error');
                } else {
                    showNotification('Gagal menyimpan data!', 'error');
                }
                hideLoading();
            }
        }

        function cancelImport() {
            importedStudents = [];
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('excel-file').value = '';
        }

        // ========================================================================
        // SETTINGS FUNCTIONS
        // ========================================================================
        function loadSettings() {
            // Load from localStorage
            const savedSettings = localStorage.getItem('schoolSettings');
            if (savedSettings) {
                schoolSettings = JSON.parse(savedSettings);
            }
            
            // Populate form
            document.getElementById('setting-school-name').value = schoolSettings.schoolName;
            document.getElementById('setting-academic-year').value = schoolSettings.academicYear;
            document.getElementById('setting-address').value = schoolSettings.address;
            document.getElementById('setting-phone').value = schoolSettings.phone;
            document.getElementById('setting-email').value = schoolSettings.email;
        }

        function saveSettings() {
            // Get values from form
            schoolSettings = {
                schoolName: document.getElementById('setting-school-name').value.trim(),
                academicYear: document.getElementById('setting-academic-year').value.trim(),
                address: document.getElementById('setting-address').value.trim(),
                phone: document.getElementById('setting-phone').value.trim(),
                email: document.getElementById('setting-email').value.trim()
            };
            
            // Validate
            if (!schoolSettings.schoolName || !schoolSettings.academicYear) {
                showNotification('Nama Sekolah dan Tahun Ajaran wajib diisi!', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
            
            // Update header
            updateSchoolHeader();
            
            showNotification('Pengaturan berhasil disimpan!', 'success');
        }

        function resetSettings() {
            // Reset to default
            schoolSettings = {
                schoolName: 'SMK Negeri 4 Jakarta',
                academicYear: '2024/2025',
                address: 'Jl. Pendidikan No. 123, Jakarta Selatan',
                phone: '(021) 12345678',
                email: 'info@smkn4jakarta.sch.id'
            };
            
            // Save and reload form
            localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
            loadSettings();
            updateSchoolHeader();
            
            showNotification('Pengaturan direset ke default!', 'success');
        }

        function updateSchoolHeader() {
            const header = document.getElementById('school-header');
            if (header) {
                header.textContent = `${schoolSettings.schoolName} - Tahun Ajaran ${schoolSettings.academicYear}`;
            }
        }

        // ========================================================================
        // INITIALIZATION
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ App initialized!');
            
            // Load settings from localStorage
            const savedSettings = localStorage.getItem('schoolSettings');
            if (savedSettings) {
                schoolSettings = JSON.parse(savedSettings);
            }
            
            // Update header with current settings
            updateSchoolHeader();
            
            // Restore last active tab (or default to 'input')
            const lastTab = localStorage.getItem('currentTab') || 'input';
            switchTab(lastTab);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ae4969af578ea7f',t:'MTc2NTc4NzUyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
