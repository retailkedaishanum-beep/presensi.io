<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Presensi Siswa SMK</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-H { background: #d1fae5; color: #065f46; }
        .status-PKL { background: #dbeafe; color: #1e40af; }
        .status-S { background: #fef3c7; color: #92400e; }
        .status-I { background: #e0e7ff; color: #3730a3; }
        .status-A { background: #fee2e2; color: #991b1b; }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 4px solid #667eea;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* A4 Preview Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        /* A4 Paper Size */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        
        .print-table th {
            background: #f3f4f6;
            font-weight: bold;
        }
        
        .signature-box {
            border: 1px solid #333;
            padding: 1rem;
            min-height: 80px;
            margin-top: 0.5rem;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl"><!-- Header -->
   <header class="text-center mb-10 fade-in">
    <h1 class="text-5xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">üéì Sistem Presensi Siswa</h1>
    <p class="text-gray-600 text-lg">SMK Negeri 1 - Tahun Ajaran 2024/2025</p>
   </header><!-- Tabs Navigation -->
   <div class="flex flex-wrap justify-center gap-3 mb-8 fade-in"><button onclick="switchTab('input')" id="tab-input" class="tab-active px-6 py-3 rounded-lg font-semibold transition-all duration-300"> ‚úèÔ∏è Input Presensi </button> <button onclick="switchTab('recap')" id="tab-recap" class="bg-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:shadow-lg"> üìä Rekapitulasi Kelas </button> <button onclick="switchTab('recap-student')" id="tab-recap-student" class="bg-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:shadow-lg"> üë§ Rekapitulasi Per Siswa </button> <button onclick="switchTab('monthly')" id="tab-monthly" class="bg-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:shadow-lg"> üìÖ Laporan Bulanan </button> <button onclick="switchTab('students')" id="tab-students" class="bg-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 hover:shadow-lg"> üë• Kelola Siswa </button>
   </div><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center">
     <div class="loading-spinner"></div>
     <p class="mt-4 text-gray-700 font-semibold">Memuat data...</p>
    </div>
   </div><!-- Tab Content: Input Presensi -->
   <div id="content-input" class="tab-content fade-in">
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Input Presensi Harian</h2>
     <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="input-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="">-- Pilih Kelas --</option> </select>
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal</label> <input type="date" id="input-date" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
      </div>
     </div><button onclick="loadStudentsForAttendance()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full md:w-auto"> üîç Tampilkan Siswa </button>
    </div>
    <div id="attendance-form-container" class="hidden">
     <div class="card p-8">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Daftar Siswa</h3>
      <div id="students-attendance-list" class="space-y-3"></div><button onclick="saveAttendance()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold mt-6"> üíæ Simpan Presensi </button>
     </div>
    </div>
   </div><!-- Tab Content: Rekapitulasi -->
   <div id="content-recap" class="tab-content hidden">
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Rekapitulasi Per Siswa</h2>
     <div class="grid md:grid-cols-3 gap-6 mb-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="recap-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="">Semua Kelas</option> </select>
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Periode</label> <select id="recap-period" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="all">Semua Periode</option> <option value="sem1">Semester 1 (Jul-Des)</option> <option value="sem2">Semester 2 (Jan-Jun)</option> </select>
      </div>
      <div class="flex items-end"><button onclick="loadRecapitulation()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> üìà Tampilkan </button>
      </div>
     </div>
    </div>
    <div id="recap-stats" class="grid md:grid-cols-5 gap-4 mb-6 hidden"></div>
    <div id="recap-table-container" class="card p-8 overflow-x-auto hidden">
     <table class="w-full" id="recap-table">
      <thead class="bg-gradient-to-r from-purple-50 to-pink-50">
       <tr>
        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">NIS</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nama Siswa</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kelas</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Hadir</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">PKL</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Sakit</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Izin</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Alpha</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Total</th>
       </tr>
      </thead>
      <tbody id="recap-tbody" class="divide-y divide-gray-200"></tbody>
     </table>
    </div>
   </div><!-- Tab Content: Rekapitulasi Per Siswa -->
   <div id="content-recap-student" class="tab-content hidden">
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üë§ Rekapitulasi Presensi Per Siswa</h2>
     <div class="grid md:grid-cols-3 gap-6 mb-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Kelas</label> <select id="recap-student-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="">-- Pilih Kelas --</option> </select>
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Periode</label> <select id="recap-student-period" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="all">Semua Periode</option> <option value="sem1">Semester 1 (Jul-Des)</option> <option value="sem2">Semester 2 (Jan-Jun)</option> <option value="custom">Custom Periode</option> </select>
      </div>
      <div class="flex items-end"><button onclick="loadStudentRecapList()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> üîç Tampilkan Siswa </button>
      </div>
     </div>
     <div id="custom-period-fields" class="hidden grid md:grid-cols-2 gap-6 mb-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Dari Tanggal</label> <input type="date" id="recap-student-start" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Sampai Tanggal</label> <input type="date" id="recap-student-end" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
      </div>
     </div>
    </div>
    <div id="student-cards-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
   </div><!-- A4 Preview Modal -->
   <div id="a4-preview-modal" class="modal-overlay hidden">
    <div class="modal-content">
     <div class="p-6 bg-gray-100 no-print">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-bold text-gray-800">üìÑ Preview Rekapitulasi A4</h3><button onclick="closeA4Preview()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all"> ‚úï Tutup </button>
      </div>
      <div class="flex gap-3 mb-4"><button onclick="printA4()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all flex items-center gap-2"> üñ®Ô∏è Cetak </button> <button onclick="downloadPDF()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"> üì• Download PDF </button>
      </div>
     </div>
     <div id="print-area" class="a4-paper"></div>
    </div>
   </div><!-- Tab Content: Laporan Bulanan -->
   <div id="content-monthly" class="tab-content hidden">
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìÖ Laporan Bulanan</h2>
     <div class="grid md:grid-cols-3 gap-6 mb-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Bulan</label> <select id="monthly-month" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="01">Januari</option> <option value="02">Februari</option> <option value="03">Maret</option> <option value="04">April</option> <option value="05">Mei</option> <option value="06">Juni</option> <option value="07">Juli</option> <option value="08">Agustus</option> <option value="09">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tahun</label> <select id="monthly-year" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all"> <option value="2025">2025</option> <option value="2024">2024</option> </select>
      </div>
      <div class="flex items-end"><button onclick="loadMonthlyReport()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold w-full"> üìä Tampilkan </button>
      </div>
     </div>
    </div>
    <div id="monthly-summary" class="grid md:grid-cols-4 gap-4 mb-6 hidden"></div>
    <div id="monthly-table-container" class="card p-8 overflow-x-auto hidden">
     <div class="mb-4">
      <h3 class="text-xl font-bold text-gray-800" id="monthly-title"></h3>
     </div>
     <table class="w-full" id="monthly-table">
      <thead class="bg-gradient-to-r from-purple-50 to-pink-50">
       <tr>
        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tanggal</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Hadir</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">PKL</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Sakit</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Izin</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Alpha</th>
        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Total</th>
       </tr>
      </thead>
      <tbody id="monthly-tbody" class="divide-y divide-gray-200"></tbody>
     </table>
    </div>
   </div><!-- Tab Content: Kelola Siswa -->
   <div id="content-students" class="tab-content hidden">
    <div class="card p-8 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• Kelola Data Siswa</h2><button onclick="showAddStudentForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold mb-6"> ‚ûï Tambah Siswa Baru </button>
     <div id="add-student-form" class="hidden bg-purple-50 p-6 rounded-lg mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Form Tambah Siswa</h3>
      <div class="grid md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">NIS</label> <input type="text" id="new-nis" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: 2024001">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="new-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Nama Siswa">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Jenis Kelamin</label> <select id="new-gender" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"> <option value="L">Laki-laki</option> <option value="P">Perempuan</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label> <input type="text" id="new-class" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: X - TKJ-1">
       </div>
      </div>
      <div class="flex gap-3 mt-4"><button onclick="saveNewStudent()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold"> üíæ Simpan </button> <button onclick="cancelAddStudent()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-all"> ‚ùå Batal </button>
      </div>
     </div>
     <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Filter Kelas</label> <select id="students-class-filter" onchange="loadStudentsList()" class="w-full md:w-64 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"> <option value="">Semua Kelas</option> </select>
     </div>
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead class="bg-gradient-to-r from-purple-50 to-pink-50">
        <tr>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">NIS</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nama</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">L/P</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kelas</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Aksi</th>
        </tr>
       </thead>
       <tbody id="students-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
     </div>
    </div>
   </div>
  </div>
  <script>
        // ========================================================================
        // SUPABASE CONFIGURATION - CREDENTIALS YANG BENAR
        // ========================================================================
        const SUPABASE_URL = 'https://xkvwtnbvierjgfbhhbeg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrdnd0bmJ2aWVyamdmYmhoYmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMzA5MzMsImV4cCI6MjA4MDkwNjkzM30.6NLqvOnX3IqY1FVjJH0sfeW08W-Bp4D6k9ztqKvtw50';
        
        console.log('üîß Initializing Supabase...');
        console.log('üìç URL:', SUPABASE_URL);
        console.log('üîë Key:', SUPABASE_KEY.substring(0, 20) + '...');
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ========================================================================
        // GLOBAL VARIABLES
        // ========================================================================
        let currentStudents = [];
        let allClasses = [];

        // ========================================================================
        // UTILITY FUNCTIONS
        // ========================================================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        function formatDateShort(dateString) {
            const options = { day: '2-digit', month: 'short' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // ========================================================================
        // TAB SWITCHING
        // ========================================================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('bg-white');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('tab-active');
            activeBtn.classList.remove('bg-white');
            
            // Load data based on tab
            if (tabName === 'input') {
                loadClassOptions();
                setTodayDate();
            } else if (tabName === 'recap') {
                loadClassOptions();
            } else if (tabName === 'recap-student') {
                loadClassOptions();
            } else if (tabName === 'monthly') {
                setCurrentMonth();
            } else if (tabName === 'students') {
                loadClassOptions();
                loadStudentsList();
            }
        }

        // ========================================================================
        // LOAD CLASS OPTIONS
        // ========================================================================
        async function loadClassOptions() {
            try {
                console.log('üîç Loading classes from Supabase...');
                
                const { data, error } = await supabase
                    .from('students')
                    .select('classname')
                    .eq('is_active', true);
                
                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    throw error;
                }
                
                console.log('‚úÖ Data received:', data);
                
                if (!data || data.length === 0) {
                    showNotification('‚ö†Ô∏è Tidak ada data siswa. Jalankan SQL script!', 'error');
                    return;
                }
                
                // Get unique classes
                allClasses = [...new Set(data.map(s => s.classname))].sort();
                console.log('üìö Classes found:', allClasses);
                
                // Populate all class dropdowns
                const classSelects = [
                    'input-class', 
                    'recap-class',
                    'recap-student-class',
                    'students-class-filter'
                ];
                
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    const currentValue = select.value;
                    
                    // Keep first option (placeholder)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    
                    // Add class options
                    allClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        select.appendChild(option);
                    });
                    
                    // Restore previous value if exists
                    if (currentValue) select.value = currentValue;
                });
                
                showNotification('‚úÖ Daftar kelas berhasil dimuat!', 'success');
            } catch (error) {
                console.error('‚ùå Error loading classes:', error);
                showNotification(`Gagal memuat: ${error.message}`, 'error');
            }
        }

        // ========================================================================
        // INPUT PRESENSI FUNCTIONS
        // ========================================================================
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
        }

        async function loadStudentsForAttendance() {
            const className = document.getElementById('input-class').value;
            const date = document.getElementById('input-date').value;
            
            if (!className) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            if (!date) {
                showNotification('Pilih tanggal terlebih dahulu!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Get students
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .eq('classname', className)
                    .eq('is_active', true)
                    .order('name');
                
                if (studentsError) throw studentsError;
                
                // Get existing attendance for this date
                const { data: existingAttendance, error: attendanceError } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('attendance_date', date);
                
                if (attendanceError) throw attendanceError;
                
                // Create attendance map
                const attendanceMap = {};
                existingAttendance.forEach(a => {
                    attendanceMap[a.student_id] = a.status;
                });
                
                // Store students globally
                currentStudents = students.map(s => ({
                    ...s,
                    currentStatus: attendanceMap[s.id] || 'H'
                }));
                
                // Render students list
                renderStudentsAttendance();
                
                document.getElementById('attendance-form-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Gagal memuat data siswa', 'error');
                hideLoading();
            }
        }

        function renderStudentsAttendance() {
            const container = document.getElementById('students-attendance-list');
            container.innerHTML = '';
            
            currentStudents.forEach((student, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all';
                
                row.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${student.name}</p>
                        <p class="text-sm text-gray-600">NIS: ${student.nis}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setAttendanceStatus(${index}, 'H')" 
                                class="status-btn ${student.currentStatus === 'H' ? 'bg-green-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            H
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'PKL')" 
                                class="status-btn ${student.currentStatus === 'PKL' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            PKL
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'S')" 
                                class="status-btn ${student.currentStatus === 'S' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            S
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'I')" 
                                class="status-btn ${student.currentStatus === 'I' ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            I
                        </button>
                        <button onclick="setAttendanceStatus(${index}, 'A')" 
                                class="status-btn ${student.currentStatus === 'A' ? 'bg-red-500 text-white' : 'bg-white text-gray-700'} px-4 py-2 rounded-lg font-semibold border-2 transition-all">
                            A
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        function setAttendanceStatus(index, status) {
            currentStudents[index].currentStatus = status;
            renderStudentsAttendance();
        }

        async function saveAttendance() {
            const date = document.getElementById('input-date').value;
            
            if (!currentStudents.length) {
                showNotification('Tidak ada data siswa', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Delete existing attendance for this date and students
                const studentIds = currentStudents.map(s => s.id);
                await supabase
                    .from('attendance')
                    .delete()
                    .eq('attendance_date', date)
                    .in('student_id', studentIds);
                
                // Insert new attendance
                const attendanceData = currentStudents.map(s => ({
                    student_id: s.id,
                    attendance_date: date,
                    status: s.currentStatus
                }));
                
                const { error } = await supabase
                    .from('attendance')
                    .insert(attendanceData);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Presensi berhasil disimpan!', 'success');
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('Gagal menyimpan presensi', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // REKAPITULASI FUNCTIONS
        // ========================================================================
        async function loadRecapitulation() {
            const className = document.getElementById('recap-class').value;
            const period = document.getElementById('recap-period').value;
            
            showLoading();
            
            try {
                // Build query for students
                let studentsQuery = supabase
                    .from('students')
                    .select('*')
                    .eq('is_active', true)
                    .order('classname')
                    .order('name');
                
                if (className) {
                    studentsQuery = studentsQuery.eq('classname', className);
                }
                
                const { data: students, error: studentsError } = await studentsQuery;
                if (studentsError) throw studentsError;
                
                // Build query for attendance based on period
                let attendanceQuery = supabase
                    .from('attendance')
                    .select('*');
                
                if (period === 'sem1') {
                    attendanceQuery = attendanceQuery
                        .gte('attendance_date', '2024-07-01')
                        .lte('attendance_date', '2024-12-31');
                } else if (period === 'sem2') {
                    attendanceQuery = attendanceQuery
                        .gte('attendance_date', '2025-01-01')
                        .lte('attendance_date', '2025-06-30');
                }
                
                const { data: attendance, error: attendanceError } = await attendanceQuery;
                if (attendanceError) throw attendanceError;
                
                // Calculate statistics
                const stats = {
                    totalH: 0,
                    totalPKL: 0,
                    totalS: 0,
                    totalI: 0,
                    totalA: 0
                };
                
                const studentStats = students.map(student => {
                    const studentAttendance = attendance.filter(a => a.student_id === student.id);
                    
                    const H = studentAttendance.filter(a => a.status === 'H').length;
                    const PKL = studentAttendance.filter(a => a.status === 'PKL').length;
                    const S = studentAttendance.filter(a => a.status === 'S').length;
                    const I = studentAttendance.filter(a => a.status === 'I').length;
                    const A = studentAttendance.filter(a => a.status === 'A').length;
                    
                    stats.totalH += H;
                    stats.totalPKL += PKL;
                    stats.totalS += S;
                    stats.totalI += I;
                    stats.totalA += A;
                    
                    return {
                        ...student,
                        H, PKL, S, I, A,
                        total: H + PKL + S + I + A
                    };
                });
                
                // Render stats cards
                renderRecapStats(stats);
                
                // Render table
                renderRecapTable(studentStats);
                
                document.getElementById('recap-stats').classList.remove('hidden');
                document.getElementById('recap-table-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading recapitulation:', error);
                showNotification('Gagal memuat rekapitulasi', 'error');
                hideLoading();
            }
        }

        function renderRecapStats(stats) {
            const container = document.getElementById('recap-stats');
            container.innerHTML = `
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-green-600">${stats.totalH}</div>
                    <div class="text-sm text-gray-600 mt-1">Hadir</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-blue-600">${stats.totalPKL}</div>
                    <div class="text-sm text-gray-600 mt-1">PKL</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-yellow-600">${stats.totalS}</div>
                    <div class="text-sm text-gray-600 mt-1">Sakit</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-indigo-600">${stats.totalI}</div>
                    <div class="text-sm text-gray-600 mt-1">Izin</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-red-600">${stats.totalA}</div>
                    <div class="text-sm text-gray-600 mt-1">Alpha</div>
                </div>
            `;
        }

        function renderRecapTable(studentStats) {
            const tbody = document.getElementById('recap-tbody');
            tbody.innerHTML = '';
            
            studentStats.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-purple-50 transition-all';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${student.nis}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${student.name}</td>
                    <td class="px-4 py-3 text-sm">${student.classname}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-green-600">${student.H}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-blue-600">${student.PKL}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-yellow-600">${student.S}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-indigo-600">${student.I}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-red-600">${student.A}</td>
                    <td class="px-4 py-3 text-center text-sm font-bold">${student.total}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========================================================================
        // REKAPITULASI PER SISWA FUNCTIONS
        // ========================================================================
        let currentRecapData = null;

        // Show/hide custom period fields
        document.addEventListener('DOMContentLoaded', () => {
            const periodSelect = document.getElementById('recap-student-period');
            if (periodSelect) {
                periodSelect.addEventListener('change', function() {
                    const customFields = document.getElementById('custom-period-fields');
                    if (this.value === 'custom') {
                        customFields.classList.remove('hidden');
                    } else {
                        customFields.classList.add('hidden');
                    }
                });
            }
        });

        async function loadStudentRecapList() {
            const className = document.getElementById('recap-student-class').value;
            const period = document.getElementById('recap-student-period').value;
            
            if (!className) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Get date range based on period
                let startDate, endDate;
                
                if (period === 'sem1') {
                    startDate = '2024-07-01';
                    endDate = '2024-12-31';
                } else if (period === 'sem2') {
                    startDate = '2025-01-01';
                    endDate = '2025-06-30';
                } else if (period === 'custom') {
                    startDate = document.getElementById('recap-student-start').value;
                    endDate = document.getElementById('recap-student-end').value;
                    
                    if (!startDate || !endDate) {
                        showNotification('Pilih tanggal periode!', 'error');
                        hideLoading();
                        return;
                    }
                } else {
                    // All periods
                    startDate = '2024-01-01';
                    endDate = '2025-12-31';
                }
                
                // Get students
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .eq('classname', className)
                    .eq('is_active', true)
                    .order('name');
                
                if (studentsError) throw studentsError;
                
                // Get attendance for the period
                const { data: attendance, error: attendanceError } = await supabase
                    .from('attendance')
                    .select('*')
                    .gte('attendance_date', startDate)
                    .lte('attendance_date', endDate)
                    .order('attendance_date');
                
                if (attendanceError) throw attendanceError;
                
                // Process data for each student
                const studentRecaps = students.map(student => {
                    const studentAttendance = attendance.filter(a => a.student_id === student.id);
                    
                    const H = studentAttendance.filter(a => a.status === 'H').length;
                    const PKL = studentAttendance.filter(a => a.status === 'PKL').length;
                    const S = studentAttendance.filter(a => a.status === 'S').length;
                    const I = studentAttendance.filter(a => a.status === 'I').length;
                    const A = studentAttendance.filter(a => a.status === 'A').length;
                    
                    return {
                        student,
                        attendance: studentAttendance,
                        stats: { H, PKL, S, I, A, total: H + PKL + S + I + A },
                        period: { startDate, endDate }
                    };
                });
                
                renderStudentCards(studentRecaps);
                
                document.getElementById('student-cards-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading student recapitulation:', error);
                showNotification('Gagal memuat data rekapitulasi', 'error');
                hideLoading();
            }
        }

        function renderStudentCards(studentRecaps) {
            const container = document.getElementById('student-cards-container');
            container.innerHTML = '';
            
            studentRecaps.forEach((recap, index) => {
                const { student, stats } = recap;
                
                const card = document.createElement('div');
                card.className = 'card p-6 hover:shadow-xl transition-all';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
                            <p class="text-sm text-gray-600">NIS: ${student.nis}</p>
                            <p class="text-sm text-gray-600">${student.classname} ‚Ä¢ ${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</p>
                        </div>
                        <div class="text-3xl">
                            ${student.gender === 'L' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${stats.H}</div>
                            <div class="text-xs text-gray-600">Hadir</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${stats.PKL}</div>
                            <div class="text-xs text-gray-600">PKL</div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600">${stats.S}</div>
                            <div class="text-xs text-gray-600">Sakit</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600">${stats.I}</div>
                            <div class="text-xs text-gray-600">Izin</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">${stats.A}</div>
                            <div class="text-xs text-gray-600">Alpha</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">${stats.total}</div>
                            <div class="text-xs text-gray-600">Total</div>
                        </div>
                    </div>
                    
                    <button onclick="showA4Preview(${index})" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold w-full flex items-center justify-center gap-2">
                        üëÅÔ∏è Preview & Cetak A4
                    </button>
                `;
                
                container.appendChild(card);
            });
            
            // Store data globally for preview
            window.studentRecapsData = studentRecaps;
        }

        function showA4Preview(index) {
            const recap = window.studentRecapsData[index];
            if (!recap) return;
            
            currentRecapData = recap;
            
            const { student, stats, attendance, period } = recap;
            
            // Generate A4 content
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="font-family: Arial, sans-serif; color: #333;">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 3px solid #333; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                        <h1 style="margin: 0; font-size: 24px; font-weight: bold;">SMK NEGERI 1</h1>
                        <p style="margin: 0.25rem 0; font-size: 14px;">Jl. Pendidikan No. 123, Kota, Provinsi</p>
                        <p style="margin: 0.25rem 0; font-size: 14px;">Telp: (021) 12345678 | Email: info@smkn1.sch.id</p>
                    </div>
                    
                    <!-- Title -->
                    <h2 style="text-align: center; margin: 1.5rem 0; font-size: 18px; font-weight: bold; text-transform: uppercase;">
                        Rekapitulasi Presensi Siswa
                    </h2>
                    
                    <!-- Student Info -->
                    <table style="width: 100%; margin-bottom: 1.5rem; font-size: 14px;">
                        <tr>
                            <td style="width: 120px; padding: 0.25rem 0;"><strong>NIS</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.nis}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Nama Lengkap</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.name}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Jenis Kelamin</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Kelas</strong></td>
                            <td style="padding: 0.25rem 0;">: ${student.classname}</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.25rem 0;"><strong>Periode</strong></td>
                            <td style="padding: 0.25rem 0;">: ${formatDate(period.startDate)} s/d ${formatDate(period.endDate)}</td>
                        </tr>
                    </table>
                    
                    <!-- Summary Stats -->
                    <h3 style="font-size: 16px; font-weight: bold; margin: 1.5rem 0 1rem 0;">Ringkasan Kehadiran</h3>
                    <table class="print-table" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="background: #dcfce7; color: #166534;">Hadir (H)</th>
                                <th style="background: #dbeafe; color: #1e40af;">PKL</th>
                                <th style="background: #fef3c7; color: #92400e;">Sakit (S)</th>
                                <th style="background: #e0e7ff; color: #3730a3;">Izin (I)</th>
                                <th style="background: #fee2e2; color: #991b1b;">Alpha (A)</th>
                                <th style="background: #f3e8ff; color: #6b21a8;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="text-align: center; font-weight: bold;">
                                <td style="color: #16a34a; font-size: 18px;">${stats.H}</td>
                                <td style="color: #2563eb; font-size: 18px;">${stats.PKL}</td>
                                <td style="color: #ca8a04; font-size: 18px;">${stats.S}</td>
                                <td style="color: #4f46e5; font-size: 18px;">${stats.I}</td>
                                <td style="color: #dc2626; font-size: 18px;">${stats.A}</td>
                                <td style="color: #9333ea; font-size: 18px;">${stats.total}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Detail Attendance -->
                    <h3 style="font-size: 16px; font-weight: bold; margin: 1.5rem 0 1rem 0;">Detail Presensi</h3>
                    ${attendance.length > 0 ? `
                    <table class="print-table" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">No</th>
                                <th>Tanggal</th>
                                <th style="width: 100px; text-align: center;">Status</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendance.map((att, i) => `
                                <tr>
                                    <td style="text-align: center;">${i + 1}</td>
                                    <td>${formatDate(att.attendance_date)}</td>
                                    <td style="text-align: center;">
                                        <span style="
                                            display: inline-block;
                                            padding: 4px 12px;
                                            border-radius: 12px;
                                            font-weight: bold;
                                            font-size: 11px;
                                            ${att.status === 'H' ? 'background: #dcfce7; color: #166534;' : ''}
                                            ${att.status === 'PKL' ? 'background: #dbeafe; color: #1e40af;' : ''}
                                            ${att.status === 'S' ? 'background: #fef3c7; color: #92400e;' : ''}
                                            ${att.status === 'I' ? 'background: #e0e7ff; color: #3730a3;' : ''}
                                            ${att.status === 'A' ? 'background: #fee2e2; color: #991b1b;' : ''}
                                        ">
                                            ${att.status === 'H' ? 'HADIR' : att.status === 'PKL' ? 'PKL' : att.status === 'S' ? 'SAKIT' : att.status === 'I' ? 'IZIN' : 'ALPHA'}
                                        </span>
                                    </td>
                                    <td>${att.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : '<p style="text-align: center; color: #666; padding: 2rem;">Belum ada data presensi</p>'}
                    
                    <!-- Keterangan -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-left: 4px solid #667eea; font-size: 12px;">
                        <strong>Keterangan:</strong><br>
                        <strong>H</strong> = Hadir | 
                        <strong>PKL</strong> = Praktik Kerja Lapangan | 
                        <strong>S</strong> = Sakit | 
                        <strong>I</strong> = Izin | 
                        <strong>A</strong> = Alpha (Tanpa Keterangan)
                    </div>
                    
                    <!-- Signatures -->
                    <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; font-size: 13px;">
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong>Wali Kelas,</strong></p>
                            <div class="signature-box"></div>
                            <p style="margin: 0.5rem 0 0 0; text-align: center;">(...........................)</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong>Orang Tua/Wali,</strong></p>
                            <div class="signature-box"></div>
                            <p style="margin: 0.5rem 0 0 0; text-align: center;">(...........................)</p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; text-align: center; font-size: 11px; color: #666;">
                        Dicetak pada: ${new Date().toLocaleDateString('id-ID', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}
                    </div>
                </div>
            `;
            
            // Show modal
            document.getElementById('a4-preview-modal').classList.remove('hidden');
        }

        function closeA4Preview() {
            document.getElementById('a4-preview-modal').classList.add('hidden');
            currentRecapData = null;
        }

        function printA4() {
            window.print();
        }

        async function downloadPDF() {
            if (!currentRecapData) return;
            
            showLoading();
            
            try {
                const element = document.getElementById('print-area');
                const { student, period } = currentRecapData;
                
                // Generate filename
                const studentName = student.name.replace(/\s+/g, '_');
                const periodText = `${period.startDate}_${period.endDate}`;
                const filename = `Rekapitulasi_${studentName}_${periodText}.pdf`;
                
                // PDF options
                const opt = {
                    margin: 10,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generate PDF
                await html2pdf().set(opt).from(element).save();
                
                hideLoading();
                showNotification('PDF berhasil diunduh!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Gagal mengunduh PDF', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // MONTHLY REPORT FUNCTIONS
        // ========================================================================
        function setCurrentMonth() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('monthly-month').value = month;
            document.getElementById('monthly-year').value = year;
        }

        async function loadMonthlyReport() {
            const month = document.getElementById('monthly-month').value;
            const year = document.getElementById('monthly-year').value;
            
            showLoading();
            
            try {
                const startDate = `${year}-${month}-01`;
                const endDate = `${year}-${month}-31`;
                
                const { data: attendance, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .gte('attendance_date', startDate)
                    .lte('attendance_date', endDate)
                    .order('attendance_date');
                
                if (error) throw error;
                
                // Group by date
                const dateMap = {};
                attendance.forEach(a => {
                    if (!dateMap[a.attendance_date]) {
                        dateMap[a.attendance_date] = { H: 0, PKL: 0, S: 0, I: 0, A: 0 };
                    }
                    dateMap[a.attendance_date][a.status]++;
                });
                
                // Calculate summary
                const summary = { H: 0, PKL: 0, S: 0, I: 0, A: 0 };
                Object.values(dateMap).forEach(day => {
                    summary.H += day.H;
                    summary.PKL += day.PKL;
                    summary.S += day.S;
                    summary.I += day.I;
                    summary.A += day.A;
                });
                
                // Render
                renderMonthlySummary(summary);
                renderMonthlyTable(dateMap);
                
                // Update title
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                document.getElementById('monthly-title').textContent = 
                    `Laporan Bulan ${monthNames[parseInt(month) - 1]} ${year}`;
                
                document.getElementById('monthly-summary').classList.remove('hidden');
                document.getElementById('monthly-table-container').classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                console.error('Error loading monthly report:', error);
                showNotification('Gagal memuat laporan bulanan', 'error');
                hideLoading();
            }
        }

        function renderMonthlySummary(summary) {
            const container = document.getElementById('monthly-summary');
            container.innerHTML = `
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-green-600">${summary.H}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Hadir</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-blue-600">${summary.PKL}</div>
                    <div class="text-sm text-gray-600 mt-1">Total PKL</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-yellow-600">${summary.S}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Sakit</div>
                </div>
                <div class="stat-card card p-6">
                    <div class="text-3xl font-bold text-red-600">${summary.I + summary.A}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Izin + Alpha</div>
                </div>
            `;
        }

        function renderMonthlyTable(dateMap) {
            const tbody = document.getElementById('monthly-tbody');
            tbody.innerHTML = '';
            
            Object.keys(dateMap).sort().forEach(date => {
                const day = dateMap[date];
                const total = day.H + day.PKL + day.S + day.I + day.A;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-purple-50 transition-all';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-semibold">${formatDate(date)}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-green-600">${day.H}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-blue-600">${day.PKL}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-yellow-600">${day.S}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-indigo-600">${day.I}</td>
                    <td class="px-4 py-3 text-center text-sm font-semibold text-red-600">${day.A}</td>
                    <td class="px-4 py-3 text-center text-sm font-bold">${total}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========================================================================
        // STUDENTS MANAGEMENT FUNCTIONS
        // ========================================================================
        function showAddStudentForm() {
            document.getElementById('add-student-form').classList.remove('hidden');
        }

        function cancelAddStudent() {
            document.getElementById('add-student-form').classList.add('hidden');
            document.getElementById('new-nis').value = '';
            document.getElementById('new-name').value = '';
            document.getElementById('new-class').value = '';
        }

        async function saveNewStudent() {
            const nis = document.getElementById('new-nis').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const gender = document.getElementById('new-gender').value;
            const classname = document.getElementById('new-class').value.trim();
            
            if (!nis || !name || !classname) {
                showNotification('Lengkapi semua field!', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('students')
                    .insert([{
                        nis,
                        name: name.toUpperCase(),
                        gender,
                        classname
                    }]);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Siswa berhasil ditambahkan!', 'success');
                cancelAddStudent();
                loadStudentsList();
                loadClassOptions();
            } catch (error) {
                console.error('Error adding student:', error);
                if (error.code === '23505') {
                    showNotification('NIS sudah terdaftar!', 'error');
                } else {
                    showNotification('Gagal menambahkan siswa', 'error');
                }
                hideLoading();
            }
        }

        async function loadStudentsList() {
            const classFilter = document.getElementById('students-class-filter').value;
            
            showLoading();
            
            try {
                let query = supabase
                    .from('students')
                    .select('*')
                    .order('classname')
                    .order('name');
                
                if (classFilter) {
                    query = query.eq('classname', classFilter);
                }
                
                const { data: students, error } = await query;
                if (error) throw error;
                
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-purple-50 transition-all';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${student.nis}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${student.name}</td>
                        <td class="px-4 py-3 text-sm">${student.gender}</td>
                        <td class="px-4 py-3 text-sm">${student.classname}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="status-badge ${student.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${student.is_active ? 'Aktif' : 'Nonaktif'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="toggleStudentStatus('${student.id}', ${!student.is_active})" 
                                    class="text-sm px-3 py-1 rounded ${student.is_active ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} transition-all">
                                ${student.is_active ? 'üö´ Nonaktifkan' : '‚úÖ Aktifkan'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoading();
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Gagal memuat daftar siswa', 'error');
                hideLoading();
            }
        }

        async function toggleStudentStatus(studentId, newStatus) {
            showLoading();
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({ is_active: newStatus })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                hideLoading();
                showNotification('Status siswa berhasil diubah!', 'success');
                loadStudentsList();
            } catch (error) {
                console.error('Error updating student status:', error);
                showNotification('Gagal mengubah status siswa', 'error');
                hideLoading();
            }
        }

        // ========================================================================
        // INITIALIZATION
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ App initialized!');
            switchTab('input');
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9acbc9b714199509',t:'MTc2NTUyNzQ3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
